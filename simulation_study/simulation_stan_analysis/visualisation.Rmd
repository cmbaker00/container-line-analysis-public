---
title: "Plot simulation summary data"
author: "Elena Tartaglia"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  bookdown::html_document2:
    df_print: kable
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(boot) # for inv.logit function
library(RColorBrewer) # for colour schemes in plots
library(patchwork)
# library(scales) this library is used for making percentage scales
source(here::here("simulation_study",
                  "simulation_stan_analysis",
                  "combine_simulated_data.R"))
source(here::here("case_study", "combine_stan_fit_to_real_data.R"))
```


```{r}
summary_data = summary_data %>%
  mutate(
    num_total_rows = num_line_rows + num_container_rows,
    percentage_container_data = num_container_rows/num_total_rows
    )
```



# Standard deviation of parameters



```{r sim-sd-pc, fig.cap = "Standard deviation of parameter estimates by percentage container data"}
df = summary_data %>%
  filter(num_total_rows == 1000,
         min_entry_size == 1,
         max_entry_size == 20,
         entry_correlation_sd == 0,
         !(param_name %in% c("lp__", "entry_effect[1]", "sigma_entry"))) 

ggplot(df, aes(x = percentage_container_data, y = summary_sd)) +
  geom_line() +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~param_name, scales = "free") +
  labs(title = "Standard deviation of parameter estimates by percentage container data",
       subtitle = paste0("Min entry size:", first(df$min_entry_size),
                        ", Max entry size:", first(df$max_entry_size),
                        ", Entry correlation:", first(df$entry_correlation_sd),
                        ", Num rows of data:", first(df$num_total_rows)))
```

- Standard deviation of parameter estimates increases as the percentage of container data increases.

- Exception is for `p_intercept[1]` where it drops dramatically at 100%. Why is that?


```{r sim-sd-ad, fig.cap="Standard deviation of parameter estimates by amount of data"}
df = summary_data %>%
  filter(min_entry_size == 1,
         max_entry_size == 20,
         entry_correlation_sd == 0,
         percentage_container_data == 0.5,
         !(param_name %in% c("lp__", "entry_effect[1]", "sigma_entry")))

ggplot(df, aes(x = num_total_rows, y = summary_sd)) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~param_name, scales = "free") +
  labs(title = "Standard deviation of parameter estimates by amount of data",
       subtitle = paste0("Min entry size: ", first(df$min_entry_size),
                        ", Max entry size: ", first(df$max_entry_size),
                        ", Entry correlation: ", first(df$entry_correlation_sd),
                        ", Percentage of container data: ", first(df$percentage_container_data)*100, "%"))
```


- Standard deviation of parameter estimates decreases as amount of data increases.


```{r sim-sd-es, fig.cap="Standard deviation of parameter estimates by amount of data", fig.width=16, fig.height=14}
df = summary_data %>%
  filter(min_entry_size == max_entry_size, !(param_name %in% c("lp__", "entry_effect[1]", "sigma_entry"))) %>%
  mutate(
    `Entry Size` = min_entry_size # have selected out data where min and max entry size are equal
  ) %>%
  filter(`Entry Size` > 1)

ggplot(df, aes(x = num_total_rows, y = summary_sd, color = as.factor(percentage_container_data))) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(`Entry Size`~param_name, labeller = labeller(.rows = label_both, .cols = label_value)) + 
  scale_color_discrete(name = "Ratio container data") +
  labs(title = "Standard deviation of parameter estimates by amount of data")
```



- Having a higher percentage of container data increases the standard deviation, but this matters less when entries are smaller.




# Prior

Draw from the prior and plot to see what it looks like.


```{r}
N = 1000000
set.seed(147)
pint = rnorm(N, -1, 2)
beta_doc = rnorm(N, 0, 0.5)
country_effect = rnorm(N, 0, 0.5)
sigma_entry = runif(N, 0, 0.5)
entry_effect = sapply(sigma_entry, function(sigma) rnorm(1, 0, sigma))
zeros = rep(0, N)

# 4 possible combinations: beta doc or not, entry effect or not.
prior_df = data.frame(
  pint = rep(pint, 4),
  country_effect = rep(country_effect, 4),
  beta_doc = rep(c(beta_doc, zeros), 2),
  entry_effect = c(rep(entry_effect, 2), rep(zeros, 2))
  ) %>%
  mutate(
    p = inv.logit(pint + country_effect + beta_doc + entry_effect)
  )

# old prior
pint = rnorm(N, 0, 2)
# 4 possible combinations: beta doc or not, entry effect or not.
old_prior_df = data.frame(
  pint = rep(pint, 4),
  country_effect = rep(country_effect, 4),
  beta_doc = rep(c(beta_doc, zeros), 2),
  entry_effect = c(rep(entry_effect, 2), rep(zeros, 2))
  ) %>%
  mutate(
    p = inv.logit(pint + country_effect + beta_doc + entry_effect)
  )
```


These plots assume probability of documentation is 1/2



```{r prior-ee, fig.cap="Prior with entry effect"}
p1 = prior_df %>%
  filter(entry_effect > 0) %>%
ggplot(aes(x = p)) +
  geom_histogram(breaks = seq(0,1,0.0025)) +
  labs(title = "Prior with entry effect")

p2 = old_prior_df %>%
  filter(entry_effect > 0) %>%
ggplot(aes(x = p)) +
  geom_histogram(breaks = seq(0,1,0.0025)) +
  labs(title = "Old prior with entry effect")

p1 + p2
```


```{r prior-nee, fig.cap="Prior without entry effect"}
prior_df %>%
  filter(entry_effect == 0) %>%
ggplot(aes(x = p)) +
  geom_histogram(breaks = seq(0,1,0.0025)) +
  labs(title = "Prior without entry effect")
```


# Check parameter estimates

Check parameter estimates against exact values from `simulate_data.R`.

```{r}
p_exact_vals = qlogis(c(0.001, 0.01, 0.02, 0.05, .2))
exact_df = data.frame(
  param_type = c(rep("p_intercept", length(p_exact_vals)), rep("country_effect", 3), "beta_doc"),
  param_name = c(paste0("p_intercept[", seq(length(p_exact_vals)), "]"), paste0("country_effect[", seq(3), "]"), "beta_doc"),
  yintercept = c(p_exact_vals, .5, -1, .25, -1)
)
```




```{r sim-mean-pc, fig.cap="Mean parameter estimates by percentage container data", fig.width=10}
df = summary_data %>%
  filter(num_total_rows == 1000,
         min_entry_size == 1,
         max_entry_size == 20,
         entry_correlation_sd == 0,
         !(param_name %in% c("lp__", "entry_effect[1]", "sigma_entry"))) %>%
  mutate(
    param_type = case_when(
      gsub("[^a-zA-Z]", "", param_name) == "pintercept" ~ "p_intercept",
      gsub("[^a-zA-Z]", "", param_name) == "countryeffect" ~ "country_effect",
      TRUE ~ "beta_doc"
    )
  ) %>%
  relocate(param_name, param_type)

mycolors <- colorRampPalette(brewer.pal(8, "Dark2"))(nrow(exact_df))

ggplot(df, aes(x = percentage_container_data, y = summary_mean, color = param_name)) +
  geom_point() +
  geom_line(linetype = "dashed") +
  facet_wrap(.~param_type) +
  geom_hline(data = exact_df, aes(yintercept = yintercept, color = param_name)) + 
  scale_color_manual(values=mycolors) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(title = "Mean parameter estimates by percentage container data",
       subtitle = paste("Min entry size:", first(df$min_entry_size),
                        "Max entry size:", first(df$max_entry_size),
                        "Entry correlation:", first(df$entry_correlation_sd),
                        "Num rows of data:", first(df$num_total_rows)))
  
```


- Estimates for large very negative `p_intercept` are worse.

- Estimates get worse as the percentage of container data increases


```{r sim-mean-ad, fig.cap="Mean parameter estimates by amount of data. Shaded error bars represent one standard deviation"}
df = summary_data %>%
  filter(min_entry_size == 1,
         max_entry_size == 20,
         entry_correlation_sd == 0,
         percentage_container_data == 0.5,
         !(param_name %in% c("lp__", "entry_effect[1]", "sigma_entry"))) %>%
  mutate(
    param_type = case_when(
      gsub("[^a-zA-Z]", "", param_name) == "pintercept" ~ "p_intercept",
      gsub("[^a-zA-Z]", "", param_name) == "countryeffect" ~ "country_effect",
      TRUE ~ "beta_doc"
    )
  ) %>%
  relocate(param_name, param_type)

ggplot(df, aes(x = num_total_rows, y = summary_mean, color = param_name, fill = param_name)) +
  geom_point() +
  geom_line(linetype = "dashed") +
  geom_hline(data = exact_df, aes(yintercept = yintercept, color = param_name)) + 
  scale_color_manual(values=mycolors) +
  scale_fill_manual(values=mycolors) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_ribbon(aes(ymax=summary_mean + summary_sd, ymin=summary_mean - summary_sd), alpha=0.2, linetype = 0) +
  facet_wrap(.~param_type) +
  labs(title = "Mean parameter estimates by amount of data",
       subtitle = paste0("Min entry size: ", first(df$min_entry_size),
                        ", Max entry size: ", first(df$max_entry_size),
                        ", Entry correlation: ", first(df$entry_correlation_sd),
                        ", Percentage of container data: ", first(df$percentage_container_data)*100, "%"))
```



```{r sim-mean-es, fig.cap="Mean parameter estimates by amount of data", fig.width=14, fig.height=12}
df = summary_data %>%
  filter(min_entry_size == max_entry_size, !(param_name %in% c("lp__", "entry_effect[1]", "sigma_entry"))) %>%
  mutate(
    `Entry Size` = min_entry_size # have selected out data where min and max entry size are equal
  ) %>%
  filter(`Entry Size` > 1)


ggplot(df, aes(x = num_total_rows, y = summary_mean, color = as.factor(percentage_container_data))) +
  geom_point() +
  geom_line(linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_hline(data = exact_df, aes(yintercept = yintercept, linetype = "Exact")) + 
  facet_grid(`Entry Size`~param_name, labeller = labeller(.rows = label_both, .cols = label_value)) + 
  scale_color_discrete(name = "Ratio container data") +
  scale_linetype_manual(name = "Data type", values = 1) +
  labs(title = "Mean parameter estiamtes by amount of data")

```


- Estimates of `p_intercept` for Entry size 1 are always the same. Something wrong?



# Real data plots

All data will have more parameters than line data. The overlapping parameters match (within weeks, not across), so these are the parameters we will compare. 

```{r}
raw_data_2 = raw_data %>%
  pivot_wider(id_cols = c(param_name, week),
              names_from = type,
              values_from = c(summary_mean, summary_sd, summary_rhat)) %>%
  drop_na()

old_raw_data_2 = old_raw_data %>%
  pivot_wider(id_cols = c(param_name, week),
              names_from = type,
              values_from = c(summary_mean, summary_sd, summary_rhat)) %>%
  drop_na()
```


```{r raw-line-cont, fig.cap="Comparing estimates of p_intercept[i] for all data and line only data"}
raw_data_2 %>%
  filter(str_detect(param_name, "p_intercept")) %>%
  ggplot(aes(x = summary_mean_all, y = summary_mean_line, color = param_name)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed() +
  facet_wrap(.~week, labeller = label_both) +
  theme(legend.position = "none") +
  labs(title = "Comparing estimates of p_intercept[i] for all data and line only data")
```



```{r raw-estreme, fig.cap="Estimates that differ by more than a fixed factor"}
DIFFERENCE = 0.5

raw_data_2 %>%
  mutate(
    diff = abs(summary_mean_all-summary_mean_line)
  ) %>%
  filter(str_detect(param_name, "p_intercept"), (diff > DIFFERENCE)) %>%
  ggplot(aes(x = summary_mean_all, y = summary_mean_line, color = param_name)) +
  geom_point() +
  geom_errorbar(aes(ymin = summary_mean_line+summary_sd_line, ymax = summary_mean_line-summary_sd_line)) +
  geom_errorbarh(aes(xmin=summary_mean_all-summary_sd_all, xmax=summary_mean_all+summary_sd_all)) +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed() +
  facet_wrap(.~week, labeller = label_both) +
  labs(title = paste("Estimates that differ by more than", DIFFERENCE))
```

```{r}
raw_data %>%
  pivot_wider(id_cols = c(param_name, week),
              names_from = type,
              values_from = c(summary_mean, summary_sd, summary_rhat)) %>%
  filter_all(any_vars(is.na(.))) %>%
  select(param_name, week, summary_mean_all, summary_sd_all, summary_rhat_all) %>%
  filter(str_detect(param_name, "p_intercept") | str_detect(param_name, "country_effect"))
```




```{r raw-line-cont-old, eval=FALSE, fig.cap="Comparing estimates of p_intercept[i] for all data and line only data. Using original prior."}
old_raw_data_2 %>%
  filter(str_detect(param_name, "p_intercept")) %>%
  ggplot(aes(x = summary_mean_all, y = summary_mean_line, color = param_name)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(.~week, labeller = label_both) +
  theme(legend.position = "none") +
  labs(title = "Comparing estimates of p_intercept[i] for all data and line only data",
       subtitle = "Original prior")
```

Compare data from old and new priors


```{r, eval=FALSE}
compare_priors = raw_data %>%
  filter(!str_detect(param_name, "entry_effect")) %>%
  select(param_name, week, type, summary_mean) %>%
  pivot_wider(names_from = param_name, values_from = summary_mean) %>%
  group_by(type, week) %>%
  mutate_at(.vars = vars(matches("p_intercept")),
            .funs =  ~(.x + `country_effect[1]` + beta_doc)) %>%
  select(week, type, matches("p_intercept")) %>%
  ungroup() %>%
  pivot_longer(cols = matches("p_intercept"), names_to = "param_name", values_to = "estimate") %>%
  pivot_wider(names_from = type, names_prefix = "raw_", values_from = estimate)

compare_priors = old_raw_data %>%
  filter(!str_detect(param_name, "entry_effect")) %>%
  select(param_name, week, type, summary_mean) %>%
  pivot_wider(names_from = param_name, values_from = summary_mean) %>%
  group_by(type, week) %>%
  mutate_at(.vars = vars(matches("p_intercept")),
            .funs =  ~(.x + `country_effect[1]` + beta_doc)) %>%
  select(week, type, matches("p_intercept")) %>%
  ungroup() %>%
  pivot_longer(cols = matches("p_intercept"), names_to = "param_name", values_to = "estimate") %>%
  pivot_wider(names_from = type, names_prefix = "old_", values_from = estimate) %>%
  full_join(compare_priors, by = c("week", "param_name")) 
```

```{r, eval=FALSE}
p1 = ggplot(compare_priors, aes(x = old_all, y = raw_all, color = param_name)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(.~week, labeller = label_both) +
  theme(legend.position = "none")


p2 = ggplot(compare_priors, aes(x = old_line, y = raw_line, color = param_name)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(.~week, labeller = label_both) +
  theme(legend.position = "none")

p1/p2
```


```{r, eval=FALSE}
p1 = ggplot(compare_priors, aes(x = plogis(old_all), y = plogis(raw_all), color = param_name)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(.~week, labeller = label_both, scales = "free") +
  theme(legend.position = "none")


p2 = ggplot(compare_priors, aes(x = plogis(old_line), y = plogis(raw_line), color = param_name)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(.~week, labeller = label_both, scales = "free") +
  theme(legend.position = "none")

p1/p2
```

<!-- - Based on the change in prior, we expect the results to be more negative/smaller probability, as indicated in the plots above -->


